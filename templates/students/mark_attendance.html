{% extends 'base.html' %}

{% block content %}
<h2 class="mb-4">Mark Attendance</h2>

<div class="card">
    <div class="card-body">
        <form method="post">
            {% csrf_token %}
            
            <div class="row mb-4">
                <div class="col-md-4">
                    <label class="form-label">Select Class</label>
                    <select name="class_id" id="classSelect" class="form-select select-flat" required>
                        <option value="">-- Select Class --</option>
                        {% for class in classes %}
                                <option value="{{ class.id }}">{{ class }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-4">
                    <label class="form-label">Date</label>
                    <input type="date" name="date" class="form-control" 
                           value="{{ today|date:'Y-m-d' }}" required>
                </div>
                
                <div class="col-md-4">
                    <label class="form-label">&nbsp;</label>
                    <button type="button" id="loadStudents" class="btn btn-primary w-100">
                        Load Students
                    </button>
                </div>
            </div>
            <div id="loadingAttendance" style="display: none;" class="text-center py-5">
                <div class="spinner"></div>
                 <p class="mt-3">Loading students...</p>
            </div>

            <div id="studentList" style="display: none;">
                <div class="mb-3">
                    <button type="button" class="btn btn-sm btn-success me-2" onclick="markAll('present')">
                        Mark All Present
                    </button>
                    <button type="button" class="btn btn-sm btn-danger" onclick="markAll('absent')">
                        Mark All Absent
                    </button>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Admission No.</th>
                                <th>Student Name</th>
                                <th>Roll No.</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody">
                        </tbody>
                    </table>
                </div>
                
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-check-circle"></i> Submit Attendance
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.getElementById('loadStudents').addEventListener('click', function() {
    const classId = document.getElementById('classSelect').value;
    
    if (!classId) {
        showToast('Please select a class first', 'warning');
        return;
    }
    
    fetch(`/students/get-class-students/${classId}/`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Not allowed to load this class');
            }
            return response.json();
        })
        .then(students => {
            if (students.error) {
                showToast(students.error, 'danger');
                return;
            }
            const tbody = document.getElementById('studentTableBody');
            tbody.innerHTML = '';
            
            students.forEach((student, index) => {
                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${student.admission_number}</td>
                        <td>${student.name}</td>
                        <td>${student.roll_number || '-'}</td>
                        <td>
                            <input type="hidden" name="students" value="${student.id}">
                            <select name="status_${student.id}" class="form-select form-select-sm status-select">
                                <option value="present" selected>Present</option>
                                <option value="absent">Absent</option>
                                <option value="late">Late</option>
                                <option value="excused">Excused</option>
                            </select>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            
            document.getElementById('studentList').style.display = 'block';
        })
        .catch(error => {
            showToast('Error loading students: ' + error, 'danger');
        });
});

function markAll(status) {
    const selects = document.querySelectorAll('.status-select');
    selects.forEach(select => {
        select.value = status;
    });
}
</script>
{% endblock %}
{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
/* Attendance UI Styles */
.student-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    margin-bottom: 0.75rem;
    transition: all 0.2s ease;
}

.student-card:hover {
    border-color: #0d6efd;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

/* Status Radio Group */
.status-group {
    display: flex;
    background: #f8f9fa;
    padding: 4px;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.status-option {
    flex: 1;
    position: relative;
}

.status-option input[type="radio"] {
    position: absolute;
    opacity: 0;
    cursor: pointer;
    height: 0;
    width: 0;
}

.status-label {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem;
    font-size: 0.85rem;
    font-weight: 600;
    color: #6c757d;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    user-select: none;
    height: 100%;
}

.status-label i {
    font-size: 1.1rem;
}

.status-label span.text {
    margin-left: 0.4rem;
}

/* Checked States */
.status-option input:checked + .status-label.present { background: #d1fae5; color: #047857; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
.status-option input:checked + .status-label.absent { background: #fee2e2; color: #b91c1c; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
.status-option input:checked + .status-label.late { background: #fef3c7; color: #b45309; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
.status-option input:checked + .status-label.excused { background: #dbeafe; color: #1d4ed8; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

/* Hover States (Subtle) */
.status-label.present:hover { color: #047857; background: #ecfdf5; }
.status-label.absent:hover { color: #b91c1c; background: #fef2f2; }
.status-label.late:hover { color: #b45309; background: #fffbeb; }
.status-label.excused:hover { color: #1d4ed8; background: #eff6ff; }


/* Desktop List Header */
.list-header {
    display: none;
    padding: 0.75rem 1rem;
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px 8px 0 0;
    border-bottom: none;
    font-weight: 700;
    color: #495057;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Responsive Columns */
@media (min-width: 768px) {
    .list-header { display: flex; align-items: center; }
    .col-sn { width: 5%; }
    .col-adm { width: 15%; }
    .col-name { width: 35%; }
    .col-roll { width: 10%; }
    .col-status { width: 35%; text-align: center; }
    
    .student-card {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
    }
    
    .student-col { padding: 0 0.5rem; }
}

@media (max-width: 767px) {
    .container { padding-left: 0.5rem; padding-right: 0.5rem; }
    
    .student-card {
        padding: 1rem;
        flex-direction: column;
        gap: 1rem;
    }
    
    .student-info-mobile {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .student-name {
        font-size: 1.1rem;
        font-weight: 700;
        color: #212529;
    }
    
    .status-label span.text {
        display: none; /* Hide text on mobile to save space */
    }
    
    .status-label { padding: 0.6rem; }
    .status-group { margin-top: 0.5rem; }
}
</style>

<div class="row mb-4 align-items-center">
    <div class="col-md-8">
        <h2 class="fw-bold text-dark mb-0">Attendance Register</h2>
        <p class="text-muted mb-0 small">Select class and date to take attendance</p>
    </div>
    <div class="col-md-4 text-md-end mt-3 mt-md-0">
        <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">
             <i class="bi bi-arrow-left"></i> Back
        </a>
    </div>
</div>

<div class="card border-0 shadow-sm">
    <div class="card-body p-4">
        <form method="post" id="attendanceForm">
            {% csrf_token %}
            
            <!-- Controls Grid -->
            <div class="row g-3">
                <div class="col-md-5">
                    <label class="form-label fw-bold small text-uppercase text-secondary">Class</label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0"><i class="bi bi-people-fill"></i></span>
                        <select name="class_id" id="classSelect" class="form-select border-start-0 ps-0 bg-light" required>
                            <option value="">Select a class...</option>
                            {% for class in classes %}
                                <option value="{{ class.id }}">{{ class }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="col-md-5">
                    <label class="form-label fw-bold small text-uppercase text-secondary">Date</label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0"><i class="bi bi-calendar-event"></i></span>
                        <input type="date" name="date" class="form-control border-start-0 ps-0 bg-light" 
                           value="{{ today|date:'Y-m-d' }}" required>
                    </div>
                </div>
                
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" id="loadStudents" class="btn btn-primary w-100 fw-bold py-2">
                        Load
                    </button>
                </div>
            </div>

            <!-- Loader -->
            <div id="loadingAttendance" style="display: none;" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                 <p class="mt-2 text-primary fw-medium">Fetching students...</p>
            </div>

            <!-- Results Area -->
            <div id="studentList" style="display: none;" class="mt-5">
                
                <!-- Tools -->
                <div class="d-flex flex-wrap align-items-center justify-content-between mb-3 sticky-top bg-white pt-2 pb-2" style="top: 0; z-index: 100;">
                    <div class="action-label fw-bold text-secondary text-uppercase small d-none d-md-block">
                        Mark All As:
                    </div>
                    <div class="btn-group w-100 w-md-auto" role="group">
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="markAll('present')">
                            Present
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="markAll('absent')">
                            Absent
                        </button>
                        <button type="button" class="btn btn-outline-warning btn-sm" onclick="markAll('late')">
                            Late
                        </button>
                    </div>
                </div>

                <!-- Desktop Tables Header -->
                <div class="list-header d-none d-md-flex">
                    <div class="col-sn">#</div>
                    <div class="col-adm">Adm No</div>
                    <div class="col-name">Student Name</div>
                    <div class="col-roll">Roll</div>
                    <div class="col-status">Today's Status</div>
                </div>

                <!-- Students Render Target -->
                <div id="studentCardsContainer">
                    <!-- JS Injected Content -->
                </div>
                
                <div class="mt-4 pt-3 border-top">
                    <button type="submit" class="btn btn-primary btn-lg w-100 shadow-sm custom-btn">
                        <i class="bi bi-check2-circle me-2"></i> Save Attendance Register
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
document.getElementById('loadStudents').addEventListener('click', function() {
    const classId = document.getElementById('classSelect').value;
    const dateVal = document.querySelector('input[name="date"]').value;
    
    if (!classId) {
        if(window.showToast) showToast('Please select a class first', 'warning');
        else alert('Please select a class first');
        return;
    }

    if (!dateVal) {
        if(window.showToast) showToast('Please select a date', 'warning');
        else alert('Please select a date');
        return;
    }
    
    // UI Loading State
    document.getElementById('loadingAttendance').style.display = 'block';
    document.getElementById('studentList').style.display = 'none';
    
    fetch(`/students/get-class-students/${classId}/?date=${dateVal}`)
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(students => {
            document.getElementById('loadingAttendance').style.display = 'none';
            
            if (students.error) {
                if(window.showToast) showToast(students.error, 'danger');
                else alert(students.error);
                return;
            }
            
            const container = document.getElementById('studentCardsContainer');
            container.innerHTML = '';
            
            if(students.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No students found in this class.</div>';
                document.getElementById('studentList').style.display = 'block';
                return;
            }

            // Check if we are editing existing records
            const existingCount = students.filter(s => s.existing_status).length;
            if (existingCount > 0) {
                 const alertHtml = `
                    <div class="alert alert-warning alert-dismissible fade show" role="alert">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <strong>Attention:</strong> Attendance for this date has already been marked. You are currently <strong>updating</strong> existing records.
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>`;
                container.insertAdjacentHTML('beforeend', alertHtml);
            }

            students.forEach((student, index) => {
                const sn = index + 1;
                // Default to 'present' if new, otherwise use existing status
                const currentStatus = student.existing_status || 'present';

                // Render Template
                const cardHtml = `
                    <div class="student-card">
                        <input type="hidden" name="students" value="${student.id}">
                        
                        <!-- Mobile Header -->
                        <div class="student-info-mobile d-md-none w-100">
                             <div class="student-name">${student.name}</div>
                             <span class="badge bg-light text-dark border">${student.admission_number}</span>
                             <small class="text-muted d-block">Roll: ${student.roll_number || '-'}</small>
                        </div>
                        
                        <!-- Desktop Cols -->
                        <div class="col-sn d-none d-md-block text-muted student-col">${sn}</div>
                        <div class="col-adm d-none d-md-block fw-medium student-col">${student.admission_number}</div>
                        <div class="col-name d-none d-md-block fw-bold text-dark student-col">${student.name}</div>
                        <div class="col-roll d-none d-md-block text-muted student-col">${student.roll_number || '-'}</div>
                        
                        <!-- Status Selector (Responsive) -->
                        <div class="col-status student-col w-100">
                             <div class="status-group">
                                ${renderStatusOption(student.id, 'present', 'Present', 'bi-check-circle-fill', currentStatus)}
                                ${renderStatusOption(student.id, 'absent', 'Absent', 'bi-x-circle-fill', currentStatus)}
                                ${renderStatusOption(student.id, 'late', 'Late', 'bi-clock-fill', currentStatus)}
                                ${renderStatusOption(student.id, 'excused', 'Excused', 'bi-file-medical-fill', currentStatus)}
                             </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend',  cardHtml);
            });
            
            document.getElementById('studentList').style.display = 'block';
        })
        .catch(error => {
            document.getElementById('loadingAttendance').style.display = 'none';
            if(window.showToast) showToast('Error loading students: ' + error.message, 'danger');
            else alert('Error loading students: ' + error.message);
        });
});

function renderStatusOption(studentId, value, label, iconClass, currentStatus) {
    const isChecked = value === currentStatus ? 'checked' : '';
    const uniqueId = `status_${studentId}_${value}`;
    return `
        <div class="status-option">
            <input type="radio" 
                   id="${uniqueId}"
                   name="status_${studentId}" 
                   value="${value}" 
                   class="status-radio-${value}" 
                   ${isChecked}>
            <label class="status-label ${value}" for="${uniqueId}">
                <i class="bi ${iconClass}"></i>
                <span class="text">${label}</span>
            </label>
        </div>
    `;
}

function markAll(status) {
    const radios = document.querySelectorAll(`.status-radio-${status}`);
    radios.forEach(radio => {
        radio.checked = true;
    });
}
</script>
{% endblock %}
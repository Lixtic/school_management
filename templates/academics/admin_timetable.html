{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-4">
        <div>
            <h2 class="mb-1"><i class="bi bi-calendar3 me-2"></i>School Timetable Overview</h2>
            <p class="text-muted mb-0">View and manage class schedules across the school</p>
        </div>
        <div class="btn-group flex-wrap" role="group" aria-label="Quick navigation">
            <a href="{% url 'school_admin:dashboard' %}" class="btn btn-outline-primary">
                <i class="bi bi-speedometer2"></i> Dashboard
            </a>
            <a href="{% url 'academics:auto_schedule' %}" class="btn btn-success">
                <i class="bi bi-magic"></i> Auto Generate
            </a>
            <a href="{% url 'academics:class_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-diagram-3"></i> Manage Classes
            </a>
        </div>
    </div>
    
    {% if classes %}
    <div class="accordion" id="classAccordion">
        {% for class in classes %}
        <div class="accordion-item mb-3 border-0 shadow-sm">
            <h2 class="accordion-header">
                <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button" 
                        data-bs-toggle="collapse" data-bs-target="#collapse{{ class.id }}" 
                        aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" 
                        aria-controls="collapse{{ class.id }}">
                    <div class="d-flex justify-content-between align-items-center w-100 me-3">
                        <div>
                            <strong class="text-primary">{{ class.name }}</strong>
                            <span class="badge bg-info ms-2">
                                <i class="bi bi-people-fill"></i> {{ class.student_count }} students
                            </span>
                        </div>
                        {% if class.class_teacher %}
                        <small class="text-muted">
                            <i class="bi bi-person-badge"></i> {{ class.class_teacher.user.get_full_name }}
                        </small>
                        {% endif %}
                    </div>
                </button>
            </h2>
            <div id="collapse{{ class.id }}" 
                 class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" 
                 data-bs-parent="#classAccordion">
                <div class="accordion-body">
                    {% with class_id=class.id %}
                    
                    <!-- Filter schedules for this class -->
                    {% if schedules %}
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover table-sm align-middle text-center mb-0">
                            <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <tr>
                                    <th style="width: 12%;">Time</th>
                                    {% for day_code, day_label in days %}
                                    <th style="width: 17.6%;">{{ day_label }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for schedule in schedules %}
                                    {% if schedule.class_subject.class_name.id == class_id and forloop.first %}
                                        <!-- This ensures we show at least some schedules for the class -->
                                    {% endif %}
                                {% endfor %}
                                
                                <!-- Display schedule grid -->
                                <tr>
                                    <td class="fw-bold bg-light">07:00 - 08:00</td>
                                    {% for day_code, day_label in days %}
                                    <td>
                                        {% for schedule in schedules %}
                                            {% if schedule.class_subject.class_name.id == class_id and schedule.day == day_code %}
                                                {% if schedule.start_time|time:"H" == "07" or schedule.start_time|time:"H" == "7" %}
                                                <div class="p-2 bg-primary bg-opacity-10 rounded mb-1">
                                                    <div class="fw-bold text-primary small">{{ schedule.class_subject.subject.name }}</div>
                                                    {% if schedule.class_subject.teacher %}
                                                    <small class="text-muted d-block" style="font-size: 0.7rem;">
                                                        {{ schedule.class_subject.teacher.user.get_full_name|truncatechars:15 }}
                                                    </small>
                                                    {% endif %}
                                                </div>
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                
                                <tr>
                                    <td class="fw-bold bg-light">08:00 - 09:00</td>
                                    {% for day_code, day_label in days %}
                                    <td>
                                        {% for schedule in schedules %}
                                            {% if schedule.class_subject.class_name.id == class_id and schedule.day == day_code %}
                                                {% if schedule.start_time|time:"H" == "08" or schedule.start_time|time:"H" == "8" %}
                                                <div class="p-2 bg-primary bg-opacity-10 rounded mb-1">
                                                    <div class="fw-bold text-primary small">{{ schedule.class_subject.subject.name }}</div>
                                                    {% if schedule.class_subject.teacher %}
                                                    <small class="text-muted d-block" style="font-size: 0.7rem;">
                                                        {{ schedule.class_subject.teacher.user.get_full_name|truncatechars:15 }}
                                                    </small>
                                                    {% endif %}
                                                </div>
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                
                                <tr>
                                    <td class="fw-bold bg-light">09:00 - 10:00</td>
                                    {% for day_code, day_label in days %}
                                    <td>
                                        {% for schedule in schedules %}
                                            {% if schedule.class_subject.class_name.id == class_id and schedule.day == day_code %}
                                                {% if schedule.start_time|time:"H" == "09" or schedule.start_time|time:"H" == "9" %}
                                                <div class="p-2 bg-primary bg-opacity-10 rounded mb-1">
                                                    <div class="fw-bold text-primary small">{{ schedule.class_subject.subject.name }}</div>
                                                    {% if schedule.class_subject.teacher %}
                                                    <small class="text-muted d-block" style="font-size: 0.7rem;">
                                                        {{ schedule.class_subject.teacher.user.get_full_name|truncatechars:15 }}
                                                    </small>
                                                    {% endif %}
                                                </div>
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                
                                <tr>
                                    <td class="fw-bold bg-light">10:00 - 11:00</td>
                                    {% for day_code, day_label in days %}
                                    <td>
                                        {% for schedule in schedules %}
                                            {% if schedule.class_subject.class_name.id == class_id and schedule.day == day_code %}
                                                {% if schedule.start_time|time:"H" == "10" %}
                                                <div class="p-2 bg-primary bg-opacity-10 rounded mb-1">
                                                    <div class="fw-bold text-primary small">{{ schedule.class_subject.subject.name }}</div>
                                                    {% if schedule.class_subject.teacher %}
                                                    <small class="text-muted d-block" style="font-size: 0.7rem;">
                                                        {{ schedule.class_subject.teacher.user.get_full_name|truncatechars:15 }}
                                                    </small>
                                                    {% endif %}
                                                </div>
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                
                                <tr>
                                    <td class="fw-bold bg-light">11:00 - 12:00</td>
                                    {% for day_code, day_label in days %}
                                    <td>
                                        {% for schedule in schedules %}
                                            {% if schedule.class_subject.class_name.id == class_id and schedule.day == day_code %}
                                                {% if schedule.start_time|time:"H" == "11" %}
                                                <div class="p-2 bg-primary bg-opacity-10 rounded mb-1">
                                                    <div class="fw-bold text-primary small">{{ schedule.class_subject.subject.name }}</div>
                                                    {% if schedule.class_subject.teacher %}
                                                    <small class="text-muted d-block" style="font-size: 0.7rem;">
                                                        {{ schedule.class_subject.teacher.user.get_full_name|truncatechars:15 }}
                                                    </small>
                                                    {% endif %}
                                                </div>
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                
                                <tr style="background: #f8f9fa;">
                                    <td class="fw-bold">BREAK</td>
                                    <td colspan="5" class="text-center text-muted">12:00 - 13:00</td>
                                </tr>
                                
                                <tr>
                                    <td class="fw-bold bg-light">13:00 - 14:00</td>
                                    {% for day_code, day_label in days %}
                                    <td>
                                        {% for schedule in schedules %}
                                            {% if schedule.class_subject.class_name.id == class_id and schedule.day == day_code %}
                                                {% if schedule.start_time|time:"H" == "13" %}
                                                <div class="p-2 bg-primary bg-opacity-10 rounded mb-1">
                                                    <div class="fw-bold text-primary small">{{ schedule.class_subject.subject.name }}</div>
                                                    {% if schedule.class_subject.teacher %}
                                                    <small class="text-muted d-block" style="font-size: 0.7rem;">
                                                        {{ schedule.class_subject.teacher.user.get_full_name|truncatechars:15 }}
                                                    </small>
                                                    {% endif %}
                                                </div>
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                
                                <tr>
                                    <td class="fw-bold bg-light">14:00 - 15:00</td>
                                    {% for day_code, day_label in days %}
                                    <td>
                                        {% for schedule in schedules %}
                                            {% if schedule.class_subject.class_name.id == class_id and schedule.day == day_code %}
                                                {% if schedule.start_time|time:"H" == "14" %}
                                                <div class="p-2 bg-primary bg-opacity-10 rounded mb-1">
                                                    <div class="fw-bold text-primary small">{{ schedule.class_subject.subject.name }}</div>
                                                    {% if schedule.class_subject.teacher %}
                                                    <small class="text-muted d-block" style="font-size: 0.7rem;">
                                                        {{ schedule.class_subject.teacher.user.get_full_name|truncatechars:15 }}
                                                    </small>
                                                    {% endif %}
                                                </div>
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                
                                <tr>
                                    <td class="fw-bold bg-light">15:00 - 16:00</td>
                                    {% for day_code, day_label in days %}
                                    <td>
                                        {% for schedule in schedules %}
                                            {% if schedule.class_subject.class_name.id == class_id and schedule.day == day_code %}
                                                {% if schedule.start_time|time:"H" == "15" %}
                                                <div class="p-2 bg-primary bg-opacity-10 rounded mb-1">
                                                    <div class="fw-bold text-primary small">{{ schedule.class_subject.subject.name }}</div>
                                                    {% if schedule.class_subject.teacher %}
                                                    <small class="text-muted d-block" style="font-size: 0.7rem;">
                                                        {{ schedule.class_subject.teacher.user.get_full_name|truncatechars:15 }}
                                                    </small>
                                                    {% endif %}
                                                </div>
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    </td>
                                    {% endfor %}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-warning mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        No schedule created for this class yet. 
                        <a href="{% url 'academics:auto_schedule' %}" class="alert-link">Generate schedule automatically</a>
                    </div>
                    {% endif %}
                    
                    {% endwith %}
                    
                    <div class="mt-3 text-end">
                        <a href="{% url 'academics:class_timetable' class.id %}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-eye"></i> View Full Schedule
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="bi bi-calendar-x" style="font-size: 4rem; color: #cbd5e1;"></i>
            <h4 class="mt-3 text-muted">No Classes Found</h4>
            <p class="text-muted">Create classes first to manage timetables</p>
            <a href="{% url 'academics:class_list' %}" class="btn btn-primary mt-2">
                <i class="bi bi-plus-circle"></i> Create Classes
            </a>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
